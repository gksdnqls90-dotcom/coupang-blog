<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <title>icbhplus 관리자</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            margin: 0;
            padding: 32px;
            background: #020817;
            color: #e5e7eb;
        }

        .wrap {
            max-width: 960px;
            margin: 0 auto;
        }

        h1 {
            margin: 0 0 8px;
            font-size: 24px;
        }

        p.sub {
            margin: 0 0 24px;
            font-size: 13px;
            color: #9ca3af;
        }

        .box {
            background: #0b1120;
            border-radius: 16px;
            padding: 18px 20px;
            border: 1px solid rgba(148, 163, 253, 0.3);
            margin-bottom: 18px;
        }

        .box-title {
            font-size: 16px;
            margin-bottom: 10px;
        }

        label {
            font-size: 13px;
            display: block;
            margin-bottom: 6px;
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #1f2937;
            background: #020617;
            color: #e5e7eb;
            font-size: 14px;
        }

        button {
            margin-top: 10px;
            padding: 8px 16px;
            border-radius: 999px;
            border: none;
            background: #4f46e5;
            color: #e5e7eb;
            font-size: 13px;
            cursor: pointer;
        }

        button.danger {
            background: #b91c1c;
        }

        button:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .error {
            font-size: 12px;
            color: #f87171;
            margin-top: 6px;
        }

        .keyword-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 10px;
            margin-top: 12px;
        }

        .k-card {
            background: #020617;
            border-radius: 12px;
            padding: 10px 12px;
            border: 1px solid rgba(148, 163, 253, 0.3);
            font-size: 13px;
        }

        .k-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .k-slug {
            font-size: 11px;
            color: #9ca3af;
        }

        .home-btn {
            font-size: 13px;
            color: #a5b4fc;
            text-decoration: none;
            border: 1px solid rgba(129, 140, 248, 0.5);
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.8);
        }

        .home-btn:hover {
            background: rgba(79, 70, 229, 0.3);
        }
    </style>
</head>

<body>
    <div class="wrap">
        <h1>icbhplus 관리자</h1>
        <p class="sub">비밀번호를 입력하면 키워드를 관리할 수 있습니다.</p>

        <!-- 비밀번호 입력 박스 -->
        <div class="box" id="pwBox">
            <div class="box-title">관리자 로그인</div>
            <label for="pwInput">비밀번호</label>
            <input id="pwInput" type="password" placeholder="비밀번호" />
            <button id="pwBtn">확인</button>
            <div class="error" id="pwError" style="display:none;">비밀번호가 올바르지 않습니다.</div>
        </div>

        <!-- 실제 관리 UI -->
        <div id="adminUI" style="display:none;">
            <!-- 키워드 추가 -->
            <div class="box">
                <div class="box-title">새 키워드 추가</div>
                <label for="keywordInput">키워드 (예: 공기청정기 추천)</label>
                <input id="keywordInput" type="text" placeholder="공기청정기 추천" />
                <button id="addBtn">추가</button>
                <div class="error" id="addError" style="display:none;"></div>
            </div>
            <div style="margin-bottom: 20px;">
                <a href="/index.html" class="home-btn">← 홈으로 돌아가기</a>
            </div>

            <!-- 등록된 키워드 목록 -->
            <div class="box">
                <div class="box-title">등록된 키워드 목록</div>
                <div id="listEmpty" style="font-size:13px; color:#9ca3af;">목록을 불러오는 중입니다…</div>
                <div class="keyword-list" id="keywordList"></div>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_PW = '1938';
        const API_BASE = '/.netlify/functions';

        const pwBox = document.getElementById('pwBox');
        const pwInput = document.getElementById('pwInput');
        const pwBtn = document.getElementById('pwBtn');
        const pwError = document.getElementById('pwError');
        const adminUI = document.getElementById('adminUI');

        const keywordInput = document.getElementById('keywordInput');
        const addBtn = document.getElementById('addBtn');
        const addError = document.getElementById('addError');
        const listEmpty = document.getElementById('listEmpty');
        const keywordList = document.getElementById('keywordList');

        // 로그인
        pwBtn.addEventListener('click', () => {
            if (pwInput.value === ADMIN_PW) {
                pwError.style.display = 'none';
                pwBox.style.display = 'none';
                adminUI.style.display = 'block';
                loadKeywords();
            } else {
                pwError.style.display = 'block';
            }
        });

        // 키워드 목록 불러오기
        async function loadKeywords() {
            listEmpty.textContent = '목록을 불러오는 중입니다…';
            keywordList.innerHTML = '';
            try {
                const res = await fetch(`${API_BASE}/getKeywords`);
                const list = await res.json(); // getKeywords는 배열을 바로 리턴함
                if (!list.length) {
                    listEmpty.textContent = '등록된 키워드가 없습니다.';
                    return;
                }
                listEmpty.textContent = '';
                list.forEach((item) => appendKeywordCard(item));
            } catch (e) {
                console.error(e);
                listEmpty.textContent = '목록을 불러오는 중 오류가 발생했습니다.';
            }
        }

        function appendKeywordCard(item) {
            const div = document.createElement('div');
            div.className = 'k-card';

            const liveUrl = `/live/${item.slug}`;

            div.innerHTML = `
        <div class="k-main">
          <span>${item.keyword}</span>
          <button class="danger" data-id="${item.id}">삭제</button>
        </div>
        <div class="k-slug">${liveUrl}</div>
      `;

            const delBtn = div.querySelector('button.danger');
            delBtn.addEventListener('click', async () => {
                if (!confirm(`"${item.keyword}" 키워드를 삭제할까요?`)) return;
                try {
                    await fetch(`${API_BASE}/deleteKeywords`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: item.id }),
                    });
                    loadKeywords();
                } catch (e) {
                    alert('삭제 중 오류가 발생했습니다.');
                }
            });

            keywordList.appendChild(div);
        }

        // 키워드 추가
        addBtn.addEventListener('click', async () => {
            const keyword = keywordInput.value.trim();
            if (!keyword) {
                addError.textContent = '키워드를 입력해 주세요.';
                addError.style.display = 'block';
                return;
            }
            addError.style.display = 'none';
            addBtn.disabled = true;
            try {
                const res = await fetch(`${API_BASE}/saveKeywords`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword }),
                });
                if (!res.ok) {
                    const t = await res.text();
                    addError.textContent = `저장 실패: ${t}`;
                    addError.style.display = 'block';
                } else {
                    keywordInput.value = '';
                    await loadKeywords();
                }
            } catch (e) {
                console.error(e);
                addError.textContent = '저장 중 오류가 발생했습니다.';
                addError.style.display = 'block';
            } finally {
                addBtn.disabled = false;
            }
        });
    </script>
</body>

</html>