<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>icbhplus · 쿠팡 추천 리스트</title>
  <meta name="description" content="쿠팡 파트너스 추천 상품 키워드 모음" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      margin: 0;
      padding: 32px;
      background: #020817;
      color: #e5e7eb;
    }

    header.wrap {
      max-width: 1080px;
      margin: 0 auto 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    .topbar {
      font-size: 11px;
      color: #64748b;
      margin-bottom: 4px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 28px;
    }

    p.sub {
      margin: 0;
      font-size: 13px;
      color: #9ca3af;
    }

    .admin-link {
      font-size: 12px;
      color: #a5b4fc;
      text-decoration: none;
      border: 1px solid rgba(129, 140, 248, 0.5);
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      white-space: nowrap;
    }

    .admin-link:hover {
      background: rgba(79, 70, 229, 0.3);
    }

    /* 검색 영역 */
    .search-wrap {
      max-width: 1080px;
      margin: 0 auto 18px;
    }

    .search-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid #1e293b;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
      box-sizing: border-box;
      outline: none;
    }

    .search-input::placeholder {
      color: #6b7280;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 14px;
      max-width: 1080px;
      margin: 0 auto;
    }

    .card {
      position: relative;
      background: #111827;
      border-radius: 16px;
      padding: 12px 14px;
      border: 1px solid rgba(148, 163, 253, 0.16);
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.55);
      transition: all 0.18s ease;
      cursor: pointer;

      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 24px 55px rgba(15, 23, 42, 0.9);
      border-color: #38bdf8;
    }

    .card-thumb {
      width: 64px;
      height: 64px;
      border-radius: 12px;
      overflow: hidden;
      flex-shrink: 0;
      background: #020617;
    }

    .card-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .card-body {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .card-title {
      font-size: 16px;
      margin: 0;
      color: #e5e7eb;
    }

    .card-link {
      font-size: 13px;
      color: #38bdf8;
      text-decoration: none;
    }

    .badge {
      display: inline-block;
      margin-top: 2px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      background: rgba(56, 189, 248, 0.12);
      color: #38bdf8;
      align-self: flex-start;
    }

    .empty {
      max-width: 1080px;
      margin: 40px auto;
      font-size: 13px;
      color: #9ca3af;
    }
  </style>
</head>

<body>
  <header class="wrap">
    <div>
      <div class="topbar">icbhplus · 쿠팡 추천 포털</div>
      <h1>쿠팡 추천 리스트</h1>
      <p class="sub">요즘 인기 키워드를 검색해 추천 리스트를 확인해보세요.</p>
    </div>
    <!-- admin 경로는 실제 배포 파일 이름에 맞춰서 /admin 또는 /admin.html 로 사용 -->
    <a href="/admin.html" class="admin-link">관리자 페이지 →</a>
  </header>

  <div class="search-wrap">
    <input id="searchInput" class="search-input" type="text" placeholder="키워드 검색 (예: 영양제, 공기청정기, 노트북...)" />
  </div>

  <main class="grid" id="cards"></main>
  <div class="empty" id="emptyMsg" style="display:none;"></div>

  <script>
    const API_BASE = '/.netlify/functions';
    const cardsEl = document.getElementById('cards');
    const emptyMsgEl = document.getElementById('emptyMsg');
    const searchInput = document.getElementById('searchInput');

    let allKeywords = [];
    let currentQuery = '';

    function createCard(item) {
      const keyword = item.keyword || '';
      const slug = item.slug || '';
      const imageUrl = item.imageUrl || null;

      const article = document.createElement('article');
      article.className = 'card';

      const linkHref = `/live/${encodeURIComponent(slug)}`;

      // 썸네일이 있는 경우만 이미지 박스 표시
      let thumbHtml = '';
      if (imageUrl) {
        thumbHtml = `
          <div class="card-thumb">
            <img src="${imageUrl}" alt="${keyword} 대표 상품" loading="lazy">
          </div>
        `;
      }

      article.innerHTML = `
        ${thumbHtml}
        <div class="card-body">
          <div class="card-title">${keyword}</div>
          <a class="card-link" href="${linkHref}" target="_blank" rel="noopener noreferrer">
            바로 보기 →
          </a>
          <div class="badge">실시간 생성</div>
        </div>
      `;

      // 카드 전체 클릭 시 링크 열기
      article.addEventListener('click', (e) => {
        if (e.target.tagName.toLowerCase() !== 'a') {
          window.open(linkHref, '_blank');
        }
      });

      return article;
    }

    function renderList(list) {
      cardsEl.innerHTML = '';
      list.forEach((item) => {
        cardsEl.appendChild(createCard(item));
      });
    }

    function applyFilter() {
      const q = currentQuery.trim();

      if (!allKeywords.length) {
        cardsEl.innerHTML = '';
        emptyMsgEl.style.display = 'block';
        emptyMsgEl.textContent =
          '등록된 키워드가 없습니다. 관리자 페이지에서 첫 키워드를 추가해 보세요.';
        return;
      }

      if (!q) {
        renderList(allKeywords);
        emptyMsgEl.style.display = 'none';
        return;
      }

      const lowerQ = q.toLowerCase();
      const filtered = allKeywords.filter((item) =>
        (item.keyword || '').toLowerCase().includes(lowerQ)
      );

      if (filtered.length === 0) {
        cardsEl.innerHTML = '';
        emptyMsgEl.style.display = 'block';
        emptyMsgEl.textContent = `"${q}" 에 대한 검색 결과가 없습니다.`;
      } else {
        emptyMsgEl.style.display = 'none';
        renderList(filtered);
      }
    }

    async function loadKeywords() {
      try {
        const res = await fetch(`${API_BASE}/getKeywords`);
        const list = await res.json();
        allKeywords = Array.isArray(list) ? list : [];
        applyFilter();
      } catch (e) {
        console.error(e);
        allKeywords = [];
        cardsEl.innerHTML = '';
        emptyMsgEl.style.display = 'block';
        emptyMsgEl.textContent =
          '키워드를 불러오는 중 오류가 발생했습니다.';
      }
    }

    // 검색창 입력 이벤트
    searchInput.addEventListener('input', (e) => {
      currentQuery = e.target.value;
      applyFilter();
    });

    // URL에서 초기 검색어 가져오기 (?q=영양제 또는 /영양제)
    (function initQueryFromURL() {
      const params = new URLSearchParams(window.location.search);
      const q = params.get('q') || '';
      if (q) {
        currentQuery = q;
        searchInput.value = q;
      } else {
        const path = window.location.pathname || '/';
        if (!path.startsWith('/live/')) {
          const segment = decodeURIComponent(
            path.replace(/^\/+/, '').split('/')[0]
          );
          if (segment) {
            currentQuery = segment;
            searchInput.value = segment;
          }
        }
      }
    })();

    loadKeywords();
  </script>
</body>

</html>